# ios多线程GCD

> 学习博客地址：https://www.jianshu.com/p/e0999fb9d74f



### 使用内容

1. `DispatchWorkItem` :调度工作项。把想要执行的代码写成闭包，在DispatchWorkItem初始化时传进去，方便后续管理任务
2. `DispatchQueue`:调度队列。一个对象，用来管理任务在app的主线程或后台线程串行或并行执行。
   - Main queue：与主线程关联，串行队列，与ui相关操作放在此处。
   - Global queue：运行在后台，系统内共享的全局队列，并行队列处理并发任务
   - Custom queue：运行在后台，默认是串行队列（Serial），初始化时指定attributes参数为 .concurrent，可以创建成并行队列（Concurrent）
3. `DispatchGroup`:一个小组，你可以把多项任务放到一个组里，方便进行统一管理。可以用`notify()`和`wait()` 方法。
   - `group.notify()`: 在某个队列上来监听group的完成，同时不会阻塞当前线程
   - `group.wait`：阻塞当前线程来等待。



### 同步异步调度

#### 追加异步任务async

- 主队列追加异步任务，顺序执行
- 全局队列追加异步任务，随机执行
- 自定义串行队列追加异步任务，顺序执行，自定义队列默认串行
- 自定义并行队列追加异步任务，随机执行。

#### 追加同步任务sync

- 主队列追加同步任务，引起死锁
- 全局队列追加同步任务，顺序执行
- 自定义串行和并行队列追加同步任务，顺序执行

#### 同步异步混合

- 主队列引起死锁
- 全局队列同步异步混合，同步任务顺序打印，异步任务随机打印。
- 自定义串行队列同步异步混合，顺序打印
- 自定义并行队列同步异步混合，同步任务顺序执行，异步任务随机执行。



### 关于死锁

1. 主队列只要有同步任务，就会死锁
   - 主队列只能运行在主线程
   - 主队列不能开启后台线程去干别的事情
   - 主队列一旦有同步任务，就会跟已经存在的异步任务相互等待，导致死锁
2. 自定义串行队列嵌套同步任务，会引起死锁（无论外层是同步还是异步）；自定义并行队列不会
3. 主队列上的所有任务（只有可能是异步任务）和其他队列的同步任务都运行在主线程上（主线程有且只有一个）（注意：**线程和队列是两个概念**）
4. 线程不在乎任务是同步还是异步，只有队列才在乎
5. 线程不会死锁，只有队列才会死锁



### 在网络请求中

- 因为主线程以及所有队列中的同步任务都会在主线程中执行，所以如果同步执行了时间很长的任务，或者主线程运行长耗时任务都会导致界面严重卡顿就会阻塞UI很久，所以：能异步执行的长耗时任务，千万不要同步执行。 长耗时同步任务欠下的债，都由界面来偿还
- 使用GCD多线程处理网络请求的正确做法：请求网络以及拿回数据后的处理都定义成异步任务，在并行队列中嵌套异步任务，最后切换到主队列去刷新UI，这样做界面可以保证最流畅。
- 可以利用dispatchGroup在主队列上监听，当完成后，执行刷新UI
- 对于嵌套可以换成队列挂起`suspend()` 和队列恢复`resume()`



### 线程安全

#### 设置barrier标识

- 自定义队列支持DispatchWorkItem设置flags为.barrier，可以支持barrier之前的任务全部执行完毕后，再执行.barrier任务，最后再执行.barrier之后的任务，这样处理可以保证线程安全。

#### 使用DispatchSemaphore上锁

- 初始化时有一个value标识还可以执行多少个异步任务
- 两个方法：
  - wait()：执行一次，value数量减1，通行数量为0时就表示红灯，全都得等着
  - signal()：执行一次，value数量加1

#### 使用串行队列+计算属性，修改变量



### DispatchQoS

1. 可以用来修饰DispatchWorkItem、DispatchQueue

2. 应用在任务上的服务质量或执行优先级

3. 类型

   - userInteractive: 与用户交互相关的任务，要最重视，优先处理，保证界面最流畅
   - userInitiated: 用户主动发起的任务，要比较重视
   - default: 默认任务，正常处理即可
   - utility: 用户没有主动关注的任务
   - background: 不太重要的维护、清理等任务，有空能处理完就行
   - unspecified: 别说身份了，连身份证都没有，能处理就处理，不能处理也无所谓的

   

